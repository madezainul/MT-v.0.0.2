<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security" layout:decorate="~{layouts/dashboard}">

<body>
    <div layout:fragment="content">
        <div class="page-inner">
            <!-- Breadcrumbs -->
            <div class="page-header">
                <h4 class="page-title" th:text="${title}"></h4>
                <ul class="breadcrumbs">
                    <li class="nav-home">
                        <i class="fas fa-user-circle mr-2"></i>
                    </li>
                    <li class="separator">
                        <i class="flaticon-right-arrow"></i>
                    </li>
                    <li class="nav-item">
                        <a>Menu</a>
                    </li>
                    <li class="separator">
                        <i class="flaticon-right-arrow"></i>
                    </li>
                    <li class="nav-item">
                        <a th:text="${title}"></a>
                    </li>
                </ul>
            </div>

            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div class="card card-profile">
                        <!-- Cover Image & Profile Picture -->
                        <div class="card-header"
                            style="background-image: url('/assets/img/blogpost.jpg'); background-size: cover; height: 160px; position: relative;">
                            <div class="profile-picture"
                                style="position: absolute; bottom: -40px; left: 50%; transform: translateX(-50%); z-index: 2;">
                                <div class="avatar avatar-xxl">
                                    <img id="profileImagePreview"
                                        th:src="${currentUser.image != null} ? @{/upload/user/image/__${currentUser.image}__} : @{/assets/img/arashmil.jpg}"
                                        alt="Foto Profil"
                                        class="avatar-img rounded-circle border border-white border-3">
                                </div>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <ul class="nav nav-tabs nav-line nav-color-primary nav-justified mt-4" id="profileTab"
                            role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="profile-tab" data-toggle="tab" href="#profile" role="tab"
                                    aria-controls="profile" aria-selected="true">
                                    <i class="fas fa-user mr-1"></i> Profil
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="records-tab" data-toggle="tab" href="#records" role="tab"
                                    aria-controls="records" aria-selected="false">
                                    <i class="fas fa-book-open mr-1"></i> Borrowing History
                                </a>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="profileTabContent">
                            <!-- Profile Tab -->
                            <div class="tab-pane fade show active" id="profile" role="tabpanel"
                                aria-labelledby="profile-tab">
                                <div class="card-body pt-4">
                                    <form class="contact-form" th:action="@{/users/update}" method="POST"
                                        enctype="multipart/form-data">
                                        <!-- Hidden ID (use 'id' from UserDTO) -->
                                        <input type="hidden" name="id" th:value="${currentUser.id}">
                                        <input type="hidden" name="redirectUrl" id="redirectUrl">

                                        <div class="form-row">
                                            <!-- Name -->
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="name">Nama <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="name" name="name"
                                                        th:value="${currentUser.name}" required>
                                                </div>
                                            </div>

                                            <!-- Employee ID -->
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="employeeId">Employee ID <span
                                                            class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="employeeId"
                                                        name="employeeId" th:value="${currentUser.employeeId}" required>
                                                </div>
                                            </div>

                                            <!-- Email -->
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="email">Email <span class="text-danger">*</span></label>
                                                    <input type="email" class="form-control" id="email" name="email"
                                                        th:value="${currentUser.email}" required>
                                                </div>
                                            </div>

                                            <!-- Role (display only — disabled) -->
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label>Role <span class="text-danger">*</span></label>
                                                    <div class="mt-1">
                                                        <!-- Display current roles -->
                                                        <span th:if="${#sets.isEmpty(currentUser.roles)}" class="text-muted">No
                                                            roles assigned</span>
                                                        <span th:unless="${#sets.isEmpty(currentUser.roles)}">
                                                            <span th:each="role : ${currentUser.roles}"
                                                                class="badge badge-primary rounded-pill px-3 py-2 mr-2 mb-1"
                                                                th:text="${role.name}">
                                                            </span>
                                                        </span>

                                                        <!-- Hidden inputs to preserve roles during form submission -->
                                                        <input type="hidden" th:each="role : ${currentUser.roles}"
                                                            name="roleNames" th:value="${role.name}" />
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Status (display only — disabled) -->
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label>Status <span class="text-danger">*</span></label>
                                                    <div class="mt-1">
                                                        <span class="badge badge-primary rounded-pill px-3 py-2"
                                                            th:text="${currentUser.status}">
                                                        </span>
                                                        <!-- Hidden input for form submission (immutable) -->
                                                        <input type="hidden" name="status" th:value="${currentUser.status}" />
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Optional: Add more fields if needed (e.g., phone, designation) -->
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="phoneNumber">Phone Number</label>
                                                    <input type="text" class="form-control" id="phoneNumber"
                                                        name="phoneNumber" th:value="${currentUser.phoneNumber}">
                                                </div>
                                            </div>

                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="designation">Designation</label>
                                                    <input type="text" class="form-control" id="designation"
                                                        name="designation" th:value="${currentUser.designation}">
                                                </div>
                                            </div>

                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="joinDate">Join Date</label>
                                                    <input type="date" class="form-control" id="joinDate"
                                                        name="joinDate"
                                                        th:value="${#temporals.format(currentUser.joinDate, 'yyyy-MM-dd')}">
                                                </div>
                                            </div>

                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="nationality">Nationality</label>
                                                    <input type="text" class="form-control" id="nationality"
                                                        name="nationality" th:value="${currentUser.nationality}">
                                                </div>
                                            </div>

                                            <!-- Profile Picture -->
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label>Image</label>
                                                    <div class="mb-2">
                                                        <img id="editImagePreview" src="" alt="No image"
                                                            class="img-thumbnail"
                                                            style="max-height: 150px; display: none;">
                                                    </div>

                                                    <div class="custom-control custom-checkbox mb-2">
                                                        <input type="checkbox" class="custom-control-input"
                                                            id="deleteImage" name="deleteImage" value="true">
                                                        <label class="custom-control-label" for="deleteImage">
                                                            <small>Remove current image</small>
                                                        </label>
                                                    </div>

                                                    <div class="custom-file">
                                                        <input type="file" class="custom-file-input" id="editImageInput"
                                                            name="imageFile" accept="image/*">
                                                        <label class="custom-file-label" for="editImageInput">Change
                                                            image...</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="text-center mt-4 mb-3">
                                            <button type="submit" class="btn btn-primary px-4">
                                                <i class="fas fa-save mr-1"></i> Save Changes
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Borrow Records Tab -->
                            <div class="tab-pane fade" id="records" role="tabpanel" aria-labelledby="records-tab">
                                <div class="card-body pt-4">
                                    <h5 class="card-title mb-3">Borrowing History</h5>
                                    <div class="table-responsive">
                                        <table id="borrow-records-table"
                                            class="display table table-striped table-hover">
                                            <thead class="bg-primary text-white">
                                                <tr>
                                                    <th>Book</th>
                                                    <th>Borrow Date</th>
                                                    <th>Due Date</th>
                                                    <th>Return Date</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Introduction to Algorithms</td>
                                                    <td>2025-04-01</td>
                                                    <td>2025-04-15</td>
                                                    <td>-</td>
                                                    <td><span class="badge badge-warning badge-shadow">Borrowed</span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Harry Potter</td>
                                                    <td>2025-03-20</td>
                                                    <td>2025-04-03</td>
                                                    <td>2025-04-05</td>
                                                    <td><span class="badge badge-success badge-shadow">Returned</span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <th:block layout:fragment="scripts">
        <!-- Update file input label -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const redirectUrlInput = document.getElementById('redirectUrl');
                if (redirectUrlInput) {
                    redirectUrlInput.value = window.location.href;
                }
                document.getElementById('editImageInput')?.addEventListener('change', function (evt) {
                    const preview = document.getElementById('editImagePreview');
                    const file = evt.target.files[0];
                    if (file && file.type.match('image.*')) {
                        const reader = new FileReader();
                        reader.onload = function () {
                            preview.src = reader.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            });
        </script>
    </th:block>
</body>

</html>