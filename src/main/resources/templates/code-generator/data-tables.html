<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security" layout:decorate="~{layouts/dashboard}">

<head>
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/atlantis.min.css">
</head>

<body>
    <div layout:fragment="content">
        <div class="page-inner">
            <div class="page-header">
                <h4 class="page-title" th:text="${title}"></h4>
                <ul class="breadcrumbs">
                    <li class="nav-home">
                        <i class="fas fa-barcode"></i>
                    </li>
                    <li class="separator">
                        <i class="flaticon-right-arrow"></i>
                    </li>
                    <li class="nav-item">
                        <a>Menu</a>
                    </li>
                    <li class="separator">
                        <i class="flaticon-right-arrow"></i>
                    </li>
                    <li class="nav-item">
                        <a th:text="${title}"></a>
                    </li>
                </ul>
            </div>
            
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex align-items-center">
                                <h4 class="card-title">Master Data Tables</h4>
                            </div>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-pills nav-secondary" id="pills-tab" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="pills-machineTypes-tab" data-toggle="pill" href="#pills-machineTypes" role="tab" aria-controls="pills-machineTypes" aria-selected="true">Machine Types</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="pills-categories-tab" data-toggle="pill" href="#pills-categories" role="tab" aria-controls="pills-categories" aria-selected="false">Categories</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="pills-subcategories-tab" data-toggle="pill" href="#pills-subcategories" role="tab" aria-controls="pills-subcategories" aria-selected="false">Subcategories</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="pills-serialNumbers-tab" data-toggle="pill" href="#pills-serialNumbers" role="tab" aria-controls="pills-serialNumbers" aria-selected="false">Capacity/Part Number</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="pills-suppliers-tab" data-toggle="pill" href="#pills-suppliers" role="tab" aria-controls="pills-suppliers" aria-selected="false">Suppliers/SN</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="pills-sections-tab" data-toggle="pill" href="#pills-sections" role="tab" aria-controls="pills-sections" aria-selected="false">Sections</a>
                                </li>
                            </ul>
                            <div class="tab-content mt-2 mb-3" id="pills-tabContent">
                                <!-- Machine Types Tab -->
                                <div class="tab-pane fade show active" id="pills-machineTypes" role="tabpanel" aria-labelledby="pills-machineTypes-tab">
                                    <div class="table-responsive">
                                        <table id="machineTypes-table" class="display table table-striped table-hover">
                                            <thead class="bg-primary text-white">
                                                <tr>
                                                    <th data-sort="code" style="cursor: pointer;">
                                                        Code <i class="fas fa-sort text-white-50 ml-1 sort-indicator"></i>
                                                    </th>
                                                    <th data-sort="name" style="cursor: pointer;">
                                                        Name <i class="fas fa-sort text-white-50 ml-1 sort-indicator"></i>
                                                    </th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="machineType,iter : ${machineTypes}">
                                                    <td data-field="code" th:text="${machineType.code}"></td>
                                                    <td data-field="name" th:text="${machineType.name}"></td>
                                                    <td>
                                                        <div class="form-button-action">
                                                            <button type="button"
                                                                class="btn btn-link btn-primary btn-lg edit-row"
                                                                th:data-id="${machineType.id}" data-type="machineType">
                                                                <i class="fa fa-edit"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-link btn-danger delete-row"
                                                                th:data-id="${machineType.id}" th:data-name="${machineType.name}" data-type="machineType">
                                                                <i class="fa fa-times"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr th:if="${#lists.isEmpty(machineTypes)}">
                                                    <td colspan="3" class="text-center text-muted">No machine types available</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Categories Tab -->
                                <div class="tab-pane fade" id="pills-categories" role="tabpanel" aria-labelledby="pills-categories-tab">
                                    <div class="table-responsive">
                                        <table id="categories-table" class="display table table-striped table-hover">
                                            <thead class="bg-primary text-white">
                                                <tr>
                                                    <th data-sort="code" style="cursor: pointer;">
                                                        Code <i class="fas fa-sort text-white-50 ml-1 sort-indicator"></i>
                                                    </th>
                                                    <th data-sort="name" style="cursor: pointer;">
                                                        Name <i class="fas fa-sort text-white-50 ml-1 sort-indicator"></i>
                                                    </th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="cat,iter : ${categories}">
                                                    <td data-field="code" th:text="${cat.code}"></td>
                                                    <td data-field="name" th:text="${cat.name}"></td>
                                                    <td>
                                                        <div class="form-button-action">
                                                            <button type="button"
                                                                class="btn btn-link btn-primary btn-lg edit-row"
                                                                th:data-id="${cat.id}" data-type="category">
                                                                <i class="fa fa-edit"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-link btn-danger delete-row"
                                                                th:data-id="${cat.id}" th:data-name="${cat.name}" data-type="category">
                                                                <i class="fa fa-times"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr th:if="${#lists.isEmpty(categories)}">
                                                    <td colspan="3" class="text-center text-muted">No categories available</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Subcategories Tab -->
                                <div class="tab-pane fade" id="pills-subcategories" role="tabpanel" aria-labelledby="pills-subcategories-tab">
                                    <div class="table-responsive">
                                        <table id="subcategories-table" class="display table table-striped table-hover">
                                            <thead class="bg-primary text-white">
                                                <tr>
                                                    <th data-sort="code" style="cursor: pointer;">
                                                        Code <i class="fas fa-sort text-white-50 ml-1 sort-indicator"></i>
                                                    </th>
                                                    <th data-sort="name" style="cursor: pointer;">
                                                        Name <i class="fas fa-sort text-white-50 ml-1 sort-indicator"></i>
                                                    </th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="subcat,iter : ${subcategories}">
                                                    <td data-field="code" th:text="${subcat.code}"></td>
                                                    <td data-field="name" th:text="${subcat.name}"></td>
                                                    <td>
                                                        <div class="form-button-action">
                                                            <button type="button"
                                                                class="btn btn-link btn-primary btn-lg edit-row"
                                                                th:data-id="${subcat.id}" data-type="subcategory">
                                                                <i class="fa fa-edit"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-link btn-danger delete-row"
                                                                th:data-id="${subcat.id}" th:data-name="${subcat.name}" data-type="subcategory">
                                                                <i class="fa fa-times"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr th:if="${#lists.isEmpty(subcategories)}">
                                                    <td colspan="3" class="text-center text-muted">No subcategories available</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Serial Numbers Tab -->
                                <div class="tab-pane fade" id="pills-serialNumbers" role="tabpanel" aria-labelledby="pills-serialNumbers-tab">
                                    <div class="table-responsive">
                                        <table id="serialNumbers-table" class="display table table-striped table-hover">
                                            <thead class="bg-primary text-white">
                                                <tr>
                                                    <th data-sort="code" style="cursor: pointer;">
                                                        Code <i class="fas fa-sort text-white-50 ml-1 sort-indicator"></i>
                                                    </th>
                                                    <th data-sort="name" style="cursor: pointer;">
                                                        Name <i class="fas fa-sort text-white-50 ml-1 sort-indicator"></i>
                                                    </th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="serialNumber,iter : ${serialNumbers}">
                                                    <td data-field="code" th:text="${serialNumber.code}"></td>
                                                    <td data-field="name" th:text="${serialNumber.name}"></td>
                                                    <td>
                                                        <div class="form-button-action">
                                                            <button type="button"
                                                                class="btn btn-link btn-primary btn-lg edit-row"
                                                                th:data-id="${serialNumber.id}" data-type="serialNumber">
                                                                <i class="fa fa-edit"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-link btn-danger delete-row"
                                                                th:data-id="${serialNumber.id}" th:data-name="${serialNumber.name}" data-type="serialNumber">
                                                                <i class="fa fa-times"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr th:if="${#lists.isEmpty(serialNumbers)}">
                                                    <td colspan="3" class="text-center text-muted">No capacity/part numbers available</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Suppliers Tab -->
                                <div class="tab-pane fade" id="pills-suppliers" role="tabpanel" aria-labelledby="pills-suppliers-tab">
                                    <div class="table-responsive">
                                        <table id="suppliers-table" class="display table table-striped table-hover">
                                            <thead class="bg-primary text-white">
                                                <tr>
                                                    <th data-sort="code" style="cursor: pointer;">
                                                        Code <i class="fas fa-sort text-white-50 ml-1 sort-indicator"></i>
                                                    </th>
                                                    <th data-sort="name" style="cursor: pointer;">
                                                        Name <i class="fas fa-sort text-white-50 ml-1 sort-indicator"></i>
                                                    </th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="supplier,iter : ${suppliers}">
                                                    <td data-field="code" th:text="${supplier.code}"></td>
                                                    <td data-field="name" th:text="${supplier.name}"></td>
                                                    <td>
                                                        <div class="form-button-action">
                                                            <button type="button"
                                                                class="btn btn-link btn-primary btn-lg edit-row"
                                                                th:data-id="${supplier.id}" data-type="supplier">
                                                                <i class="fa fa-edit"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-link btn-danger delete-row"
                                                                th:data-id="${supplier.id}" th:data-name="${supplier.name}" data-type="supplier">
                                                                <i class="fa fa-times"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr th:if="${#lists.isEmpty(suppliers)}">
                                                    <td colspan="3" class="text-center text-muted">No suppliers/SN available</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Sections Tab -->
                                <div class="tab-pane fade" id="pills-sections" role="tabpanel" aria-labelledby="pills-sections-tab">
                                    <div class="table-responsive">
                                        <table id="sections-table" class="display table table-striped table-hover">
                                            <thead class="bg-primary text-white">
                                                <tr>
                                                    <th data-sort="code" style="cursor: pointer;">
                                                        Code <i class="fas fa-sort text-white-50 ml-1 sort-indicator"></i>
                                                    </th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="section,iter : ${sections}">
                                                    <td data-field="code" th:text="${section.code}"></td>
                                                    <td>
                                                        <div class="form-button-action">
                                                            <button type="button"
                                                                class="btn btn-link btn-primary btn-lg edit-row"
                                                                th:data-id="${section.id}" data-type="section">
                                                                <i class="fa fa-edit"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-link btn-danger delete-row"
                                                                th:data-id="${section.id}" th:data-name="${section.code}" data-type="section">
                                                                <i class="fa fa-times"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr th:if="${#lists.isEmpty(sections)}">
                                                    <td colspan="2" class="text-center text-muted">No sections available</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts Fragment -->
    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            console.log('Master Data Tables - Script block executing...');
            
            document.addEventListener("DOMContentLoaded", function() {
                console.log('DOM loaded, starting initialization for all tables...');
                
                // Table IDs for all master data tables
                const tableIds = [
                    'machineTypes-table',
                    'categories-table',
                    'subcategories-table', 
                    'serialNumbers-table',
                    'suppliers-table',
                    'sections-table'
                ];
                
                // Initialize sorting for each table
                tableIds.forEach(tableId => {
                    console.log(`Initializing sorting for table: ${tableId}`);
                    initializeTableSorting(tableId);
                });

                function initializeTableSorting(tableId) {
                    const table = document.getElementById(tableId);
                    console.log(`Table element for ${tableId}:`, table);
                    
                    if (!table) {
                        console.error(`Table ${tableId} not found!`);
                        return;
                    }
                    
                    const headers = table.querySelectorAll('th[data-sort]');
                    console.log(`Found ${headers.length} sortable headers for ${tableId}:`, headers);
                    
                    let currentSort = { field: null, direction: 'asc' };

                    // Sorts table rows by field (client-side)
                    function sortTable(field, direction) {
                        console.log(`sortTable called for ${tableId} with field:`, field, 'direction:', direction);
                        
                        const tbody = table.querySelector('tbody');
                        console.log(`tbody for ${tableId}:`, tbody);
                        
                        const allRows = tbody.querySelectorAll('tr');
                        console.log(`All rows in ${tableId} tbody:`, allRows.length);
                        
                        const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => {
                            const firstCell = row.querySelector('td');
                            const hasTextCenter = firstCell && firstCell.classList.contains('text-center');
                            return firstCell && !hasTextCenter;
                        });
                        
                        console.log(`Filtered data rows for ${tableId}:`, rows.length);
                        
                        if (rows.length === 0) {
                            console.warn(`No data rows found to sort in ${tableId}`);
                            return;
                        }

                        rows.sort((a, b) => {
                            let aVal = a.querySelector(`[data-field="${field}"]`)?.textContent.trim() || '';
                            let bVal = b.querySelector(`[data-field="${field}"]`)?.textContent.trim() || '';
                            
                            console.log(`Comparing in ${tableId}:`, aVal, 'vs', bVal);

                            // Convert to lowercase for case-insensitive comparison
                            aVal = aVal.toLowerCase();
                            bVal = bVal.toLowerCase();
                            
                            if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                            if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                            return 0;
                        });

                        console.log(`Sorted rows for ${tableId}, re-appending to tbody`);
                        rows.forEach((row, index) => {
                            tbody.appendChild(row);
                        });
                        
                        console.log(`Sort complete for ${tableId}`);
                    }

                    // Set up click handlers for each sortable header
                    headers.forEach((header, index) => {
                        console.log(`Setting up click handler for ${tableId} header`, index, ':', header);
                        
                        header.addEventListener('click', function(event) {
                            console.log(`=== HEADER CLICKED in ${tableId} ===`);
                            console.log('Event:', event);
                            console.log('Header element:', header);
                            
                            const field = header.dataset.sort;
                            console.log(`Field from dataset for ${tableId}:`, field);
                            
                            const isAsc = (currentSort.field === field && currentSort.direction === 'asc');
                            const direction = isAsc ? 'desc' : 'asc';
                            
                            console.log(`Current sort for ${tableId}:`, currentSort);
                            console.log(`New direction for ${tableId}:`, direction);

                            // Reset all icons for this table
                            headers.forEach((h, idx) => {
                                console.log(`Resetting icon for ${tableId} header`, idx);
                                const icon = h.querySelector('.sort-indicator');
                                if (icon) {
                                    icon.className = 'fas fa-sort text-white-50 ml-1 sort-indicator';
                                }
                            });

                            // Update active sort indicator
                            const activeIcon = header.querySelector('.sort-indicator');
                            console.log(`Active icon element for ${tableId}:`, activeIcon);
                            if (activeIcon) {
                                activeIcon.className = `fas fa-sort-${direction === 'asc' ? 'up' : 'down'} text-white ml-1 sort-indicator`;
                                console.log(`Updated active icon classes for ${tableId}:`, activeIcon.className);
                            }

                            currentSort = { field, direction };
                            console.log(`Updated currentSort for ${tableId}:`, currentSort);
                            
                            console.log(`Calling sortTable for ${tableId}...`);
                            sortTable(field, direction);
                            console.log(`=== HEADER CLICK COMPLETE for ${tableId} ===`);
                        });
                        
                        // Add visual feedback for debugging
                        header.style.cursor = 'pointer';
                        header.title = `Click to sort by ${header.dataset.sort}`;
                    });

                    console.log(`Sorting initialized for ${tableId} with`, headers.length, 'headers');
                }

                console.log('All tables setup complete');
            });
        </script>
    </th:block>

</body>

</html>
