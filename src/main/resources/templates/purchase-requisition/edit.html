<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security" layout:decorate="~{layouts/dashboard}">

<head>
    <title>Edit Purchase Requisition</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="page-inner">
            <div class="page-header">
                <h4 class="page-title">Edit Purchase Requisition</h4>
                <ul class="breadcrumbs">
                    <li class="nav-home">
                        <i class="fas fa-shopping-cart"></i>
                    </li>
                    <li class="separator">
                        <i class="flaticon-right-arrow"></i>
                    </li>
                    <li class="nav-item">
                        <a th:href="@{/purchase-requisition}">Purchase Requisition</a>
                    </li>
                    <li class="separator">
                        <i class="flaticon-right-arrow"></i>
                    </li>
                    <li class="nav-item">
                        <a th:href="@{'/purchase-requisition/' + ${pr.id}}" th:text="${pr.code}"></a>
                    </li>
                    <li class="separator">
                        <i class="flaticon-right-arrow"></i>
                    </li>
                    <li class="nav-item">
                        <a>Edit</a>
                    </li>
                </ul>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-head-row">
                                <div class="card-title">
                                    <h3>Edit Purchase Requisition</h3>
                                    <p class="text-muted">PR Code: <span th:text="${pr.code}"></span></p>
                                </div>
                                <div class="card-tools">
                                    <a th:href="@{'/purchase-requisition/' + ${pr.id}}" class="btn btn-secondary">
                                        <i class="fa fa-arrow-left mr-1"></i> Back to Details
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <form th:action="@{'/purchase-requisition/' + ${pr.id} + '/edit'}" method="post" id="editPRForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="title">Title <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" name="title" id="title" 
                                                   th:value="${pr.title}" required maxlength="255">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="dateNeeded">Date Needed <span class="text-danger">*</span></label>
                                            <input type="date" class="form-control" name="dateNeeded" id="dateNeeded"
                                                   th:value="${#temporals.format(pr.dateNeeded, 'yyyy-MM-dd')}" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="requestorId">Requestor <span class="text-danger">*</span></label>
                                            <select class="form-control" name="requestorId" id="requestorId" required>
                                                <option value="">Select Requestor</option>
                                                <option th:each="user : ${usersList}" 
                                                        th:value="${user.id}" 
                                                        th:text="${user.name + ' (' + user.employeeId + ')'}"
                                                        th:selected="${user.id == pr.requestorId}"></option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="requestorEmail">Requestor Email</label>
                                            <input type="email" class="form-control" name="requestorEmail" id="requestorEmail"
                                                   th:value="${pr.requestorEmail}" maxlength="100" readonly>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="targetEquipmentId">Target Equipment</label>
                                            <select class="form-control" name="targetEquipmentId" id="targetEquipmentId">
                                                <option value="">Select Equipment (Optional)</option>
                                                <option th:each="equipment : ${equipmentList}" 
                                                        th:value="${equipment.id}" 
                                                        th:text="${equipment.name}"
                                                        th:selected="${equipment.id == pr.targetEquipmentId}"></option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="urgencyLevel">Urgency Level <span class="text-danger">*</span></label>
                                            <select class="form-control" name="urgencyLevel" id="urgencyLevel" required>
                                                <option value="">Select Urgency</option>
                                                <option value="LOW" th:selected="${pr.urgencyLevel == 'LOW'}">Low</option>
                                                <option value="MEDIUM" th:selected="${pr.urgencyLevel == 'MEDIUM'}">Medium</option>
                                                <option value="HIGH" th:selected="${pr.urgencyLevel == 'HIGH'}">High</option>
                                                <option value="CRITICAL" th:selected="${pr.urgencyLevel == 'CRITICAL'}">Critical</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="description">Description</label>
                                    <textarea class="form-control" name="description" id="description" rows="3"
                                              placeholder="Provide additional details about this purchase requisition"
                                              th:text="${pr.description}"></textarea>
                                </div>

                                <!-- Items Section -->
                                <div class="form-group">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>Purchase Requisition Items</h5>
                                        <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addItemModal">
                                            <i class="fas fa-plus mr-1"></i> Add Item
                                        </button>
                                    </div>

                                    <div id="itemsContainer">
                                        <div th:if="${pr.items == null or pr.items.empty}" class="text-center text-muted py-4">
                                            <i class="fas fa-box-open fa-3x mb-3"></i>
                                            <p>No items added yet. Click "Add Item" to get started.</p>
                                        </div>

                                        <div th:if="${pr.items != null and !pr.items.empty}">
                                            <div class="table-responsive">
                                                <table class="table table-bordered" id="itemsTable">
                                                    <thead class="thead-light">
                                                        <tr>
                                                            <th>Part Details</th>
                                                            <th class="text-center">Quantity</th>
                                                            <th class="text-center">Criticality</th>
                                                            <th>Justification</th>
                                                            <th class="text-center">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr th:each="item, iterStat : ${pr.items}" th:data-item-index="${iterStat.index}">
                                                            <td>
                                                                <div>
                                                                    <strong th:if="${!item.isNewPart}" th:text="${item.displayPartCode}"></strong>
                                                                    <strong th:if="${item.isNewPart}" th:text="${item.partName}"></strong>
                                                                    <span th:if="${item.isNewPart}" class="badge badge-info ml-2">New Part</span>
                                                                </div>
                                                                <div th:text="${item.displayPartName}" class="text-muted"></div>
                                                                <small class="text-muted">
                                                                    <span th:text="${item.displayCategory ?: 'N/A'}"></span> | 
                                                                    <span th:text="${item.displaySupplier ?: 'N/A'}"></span>
                                                                </small>
                                                                <!-- Hidden inputs for form submission -->
                                                                <input type="hidden" th:name="'items[' + ${iterStat.index} + '].id'" th:value="${item.id}">
                                                                <input type="hidden" th:name="'items[' + ${iterStat.index} + '].partId'" th:value="${item.partId}">
                                                                <input type="hidden" th:name="'items[' + ${iterStat.index} + '].partName'" th:value="${item.partName}">
                                                                <input type="hidden" th:name="'items[' + ${iterStat.index} + '].partDescription'" th:value="${item.partDescription}">
                                                                <input type="hidden" th:name="'items[' + ${iterStat.index} + '].partCategory'" th:value="${item.partCategory}">
                                                                <input type="hidden" th:name="'items[' + ${iterStat.index} + '].partSupplier'" th:value="${item.partSupplier}">
                                                                <input type="hidden" th:name="'items[' + ${iterStat.index} + '].isNewPart'" th:value="${item.isNewPart}">
                                                            </td>
                                                            <td class="text-center">
                                                                <input type="number" class="form-control form-control-sm text-center" 
                                                                       th:name="'items[' + ${iterStat.index} + '].quantity'" 
                                                                       th:value="${item.quantity}" min="1" required style="width: 80px;">
                                                                <input type="text" class="form-control form-control-sm mt-1" 
                                                                       th:name="'items[' + ${iterStat.index} + '].unitMeasure'" 
                                                                       th:value="${item.unitMeasure}" 
                                                                       placeholder="Unit" style="width: 80px;">
                                                            </td>
                                                            <td class="text-center">
                                                                <select class="form-control form-control-sm" 
                                                                        th:name="'items[' + ${iterStat.index} + '].criticalityLevel'" required>
                                                                    <option value="LOW" th:selected="${item.criticalityLevel == 'LOW'}">Low</option>
                                                                    <option value="MEDIUM" th:selected="${item.criticalityLevel == 'MEDIUM'}">Medium</option>
                                                                    <option value="HIGH" th:selected="${item.criticalityLevel == 'HIGH'}">High</option>
                                                                    <option value="CRITICAL" th:selected="${item.criticalityLevel == 'CRITICAL'}">Critical</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <textarea class="form-control form-control-sm" 
                                                                          th:name="'items[' + ${iterStat.index} + '].justification'" 
                                                                          rows="2" th:text="${item.justification}"></textarea>
                                                                <input type="text" class="form-control form-control-sm mt-1" 
                                                                       th:name="'items[' + ${iterStat.index} + '].notes'" 
                                                                       th:value="${item.notes}" 
                                                                       placeholder="Notes (optional)">
                                                            </td>
                                                            <td class="text-center">
                                                                <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(this)">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group text-right">
                                    <a th:href="@{'/purchase-requisition/' + ${pr.id}}" class="btn btn-secondary">Cancel</a>
                                    <button type="submit" class="btn btn-primary ml-2">
                                        <i class="fas fa-save mr-1"></i> Update Purchase Requisition
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Purchase Requisition Item</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addItemForm">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label>Part Type</label>
                                    <div class="form-check-radio">
                                        <label class="form-check-label">
                                            <input class="form-check-input" type="radio" name="partType" value="existing" checked>
                                            <span class="form-check-sign"></span>
                                            Existing Part
                                        </label>
                                    </div>
                                    <div class="form-check-radio">
                                        <label class="form-check-label">
                                            <input class="form-check-input" type="radio" name="partType" value="new">
                                            <span class="form-check-sign"></span>
                                            New Part (Not in inventory)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="existingPartSection">
                            <div class="form-group">
                                <label for="partSelect">Select Part <span class="text-danger">*</span></label>
                                <select class="form-control" id="partSelect">
                                    <option value="">Search and select a part...</option>
                                    <option th:each="part : ${partsList}" 
                                            th:value="${part.id}" 
                                            th:text="${part.code + ' - ' + part.name}"
                                            th:data-category="${part.category}"
                                            th:data-supplier="${part.supplier}"
                                            th:data-description="${part.description}"
                                            th:data-current-stock="${part.currentStock}"></option>
                                </select>
                            </div>
                        </div>

                        <div id="newPartSection" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="newPartName">Part Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="newPartName" maxlength="100">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="newPartCategory">Category</label>
                                        <input type="text" class="form-control" id="newPartCategory" maxlength="50">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="newPartSupplier">Supplier</label>
                                        <input type="text" class="form-control" id="newPartSupplier" maxlength="100">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="newPartDescription">Description</label>
                                        <input type="text" class="form-control" id="newPartDescription" maxlength="255">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="quantity">Quantity <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="quantity" min="1" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="unitMeasure">Unit of Measure</label>
                                    <input type="text" class="form-control" id="unitMeasure" placeholder="pcs, kg, m, etc.">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="criticalityLevel">Criticality <span class="text-danger">*</span></label>
                                    <select class="form-control" id="criticalityLevel" required>
                                        <option value="">Select Criticality</option>
                                        <option value="LOW">Low</option>
                                        <option value="MEDIUM">Medium</option>
                                        <option value="HIGH">High</option>
                                        <option value="CRITICAL">Critical</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="justification">Justification <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="justification" rows="2" 
                                              placeholder="Explain why this part is needed" required></textarea>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="notes">Notes</label>
                                    <textarea class="form-control" id="notes" rows="2" 
                                              placeholder="Additional notes (optional)"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addItem()">Add Item</button>
                </div>
            </div>
        </div>
    </div>

    <div layout:fragment="scripts">
        <script>
            let itemIndex = parseInt('[[${pr.items != null ? pr.items.size() : 0}]]');

            $(document).ready(function() {
                $('input[name="partType"]').change(function() {
                    if ($(this).val() === 'existing') {
                        $('#existingPartSection').show();
                        $('#newPartSection').hide();
                        $('#partSelect').prop('required', true);
                        $('#newPartName').prop('required', false);
                    } else {
                        $('#existingPartSection').hide();
                        $('#newPartSection').show();
                        $('#partSelect').prop('required', false);
                        $('#newPartName').prop('required', true);
                    }
                });

                $('#addItemModal').on('hidden.bs.modal', function() {
                    resetAddItemForm();
                });
            });

            function resetAddItemForm() {
                $('#addItemForm')[0].reset();
                $('input[name="partType"][value="existing"]').prop('checked', true);
                $('#existingPartSection').show();
                $('#newPartSection').hide();
                $('#partSelect').prop('required', true);
                $('#newPartName').prop('required', false);
            }

            function addItem() {
                const isValid = validateAddItemForm();
                if (!isValid) return;

                const isNewPart = $('input[name="partType"]:checked').val() === 'new';
                let itemData = {
                    quantity: $('#quantity').val(),
                    unitMeasure: $('#unitMeasure').val(),
                    criticalityLevel: $('#criticalityLevel').val(),
                    justification: $('#justification').val(),
                    notes: $('#notes').val(),
                    isNewPart: isNewPart
                };

                if (isNewPart) {
                    itemData.partName = $('#newPartName').val();
                    itemData.partDescription = $('#newPartDescription').val();
                    itemData.partCategory = $('#newPartCategory').val();
                    itemData.partSupplier = $('#newPartSupplier').val();
                    itemData.displayPartCode = 'NEW';
                    itemData.displayPartName = itemData.partName;
                    itemData.displayCategory = itemData.partCategory || 'N/A';
                    itemData.displaySupplier = itemData.partSupplier || 'N/A';
                } else {
                    const selectedOption = $('#partSelect option:selected');
                    itemData.partId = selectedOption.val();
                    itemData.displayPartCode = selectedOption.text().split(' - ')[0];
                    itemData.displayPartName = selectedOption.text().split(' - ')[1];
                    itemData.displayCategory = selectedOption.data('category') || 'N/A';
                    itemData.displaySupplier = selectedOption.data('supplier') || 'N/A';
                    itemData.currentStock = selectedOption.data('current-stock');
                }

                addItemToTable(itemData);
                $('#addItemModal').modal('hide');
            }

            function addItemToTable(itemData) {
                // If table doesn't exist, create it
                if ($('#itemsTable').length === 0) {
                    $('#itemsContainer').html(`
                        <div class="table-responsive">
                            <table class="table table-bordered" id="itemsTable">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Part Details</th>
                                        <th class="text-center">Quantity</th>
                                        <th class="text-center">Criticality</th>
                                        <th>Justification</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    `);
                }

                const criticalityBadge = getCriticalityBadge(itemData.criticalityLevel);
                const stockWarning = itemData.currentStock && itemData.currentStock < itemData.quantity ? 
                    '<small class="text-danger">(âš  Insufficient stock)</small>' : '';

                const row = `
                    <tr data-item-index="${itemIndex}">
                        <td>
                            <div>
                                <strong>${itemData.displayPartCode}</strong>
                                ${itemData.isNewPart ? '<span class="badge badge-info ml-2">New Part</span>' : ''}
                            </div>
                            <div class="text-muted">${itemData.displayPartName}</div>
                            <small class="text-muted">${itemData.displayCategory} | ${itemData.displaySupplier}</small>
                            ${stockWarning}
                            <!-- Hidden inputs -->
                            <input type="hidden" name="items[${itemIndex}].partId" value="${itemData.partId || ''}">
                            <input type="hidden" name="items[${itemIndex}].partName" value="${itemData.partName || ''}">
                            <input type="hidden" name="items[${itemIndex}].partDescription" value="${itemData.partDescription || ''}">
                            <input type="hidden" name="items[${itemIndex}].partCategory" value="${itemData.partCategory || ''}">
                            <input type="hidden" name="items[${itemIndex}].partSupplier" value="${itemData.partSupplier || ''}">
                            <input type="hidden" name="items[${itemIndex}].isNewPart" value="${itemData.isNewPart}">
                        </td>
                        <td class="text-center">
                            <input type="number" class="form-control form-control-sm text-center" 
                                   name="items[${itemIndex}].quantity" value="${itemData.quantity}" min="1" required style="width: 80px;">
                            <input type="text" class="form-control form-control-sm mt-1" 
                                   name="items[${itemIndex}].unitMeasure" value="${itemData.unitMeasure}" 
                                   placeholder="Unit" style="width: 80px;">
                        </td>
                        <td class="text-center">
                            <select class="form-control form-control-sm" name="items[${itemIndex}].criticalityLevel" required>
                                <option value="LOW" ${itemData.criticalityLevel === 'LOW' ? 'selected' : ''}>Low</option>
                                <option value="MEDIUM" ${itemData.criticalityLevel === 'MEDIUM' ? 'selected' : ''}>Medium</option>
                                <option value="HIGH" ${itemData.criticalityLevel === 'HIGH' ? 'selected' : ''}>High</option>
                                <option value="CRITICAL" ${itemData.criticalityLevel === 'CRITICAL' ? 'selected' : ''}>Critical</option>
                            </select>
                        </td>
                        <td>
                            <textarea class="form-control form-control-sm" name="items[${itemIndex}].justification" 
                                      rows="2">${itemData.justification}</textarea>
                            <input type="text" class="form-control form-control-sm mt-1" 
                                   name="items[${itemIndex}].notes" value="${itemData.notes}" 
                                   placeholder="Notes (optional)">
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;

                $('#itemsTable tbody').append(row);
                itemIndex++;
            }

            function removeItem(button) {
                $(button).closest('tr').remove();
                reindexItems();
            }

            function reindexItems() {
                $('#itemsTable tbody tr').each(function(index) {
                    $(this).attr('data-item-index', index);
                    $(this).find('input, select, textarea').each(function() {
                        const name = $(this).attr('name');
                        if (name && name.includes('items[')) {
                            const newName = name.replace(/items\[\d+\]/, `items[${index}]`);
                            $(this).attr('name', newName);
                        }
                    });
                });
                itemIndex = $('#itemsTable tbody tr').length;
            }

            function validateAddItemForm() {
                const isNewPart = $('input[name="partType"]:checked').val() === 'new';
                
                if (!isNewPart && !$('#partSelect').val()) {
                    alert('Please select a part');
                    return false;
                }
                
                if (isNewPart && !$('#newPartName').val()) {
                    alert('Please enter part name');
                    return false;
                }
                
                if (!$('#quantity').val() || $('#quantity').val() <= 0) {
                    alert('Please enter a valid quantity');
                    return false;
                }
                
                if (!$('#criticalityLevel').val()) {
                    alert('Please select criticality level');
                    return false;
                }
                
                if (!$('#justification').val()) {
                    alert('Please enter justification');
                    return false;
                }
                
                return true;
            }

            function getCriticalityBadge(level) {
                switch(level) {
                    case 'CRITICAL': return '<span class="badge badge-danger">Critical</span>';
                    case 'HIGH': return '<span class="badge badge-warning">High</span>';
                    case 'MEDIUM': return '<span class="badge badge-info">Medium</span>';
                    case 'LOW': return '<span class="badge badge-secondary">Low</span>';
                    default: return '<span class="badge badge-secondary">Unknown</span>';
                }
            }
        </script>
    </div>
</body>
</html>