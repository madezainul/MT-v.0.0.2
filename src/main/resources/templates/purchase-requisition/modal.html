<!-- Add Item Modal Fragment -->
<div class="modal fade" id="itemModal" tabindex="-1" role="dialog" th:fragment="addItemModal" 
     xmlns:th="http://www.thymeleaf.org">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add PR Item</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="itemForm">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Item Type</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="itemType" id="existingPart" value="existing" 
                                           th:checked="${partsList != null and !partsList.isEmpty()}"
                                           th:disabled="${partsList == null or partsList.isEmpty()}">
                                    <label class="form-check-label" for="existingPart">
                                        <span th:if="${partsList != null and !partsList.isEmpty()}">Existing Part from Inventory</span>
                                        <span th:if="${partsList == null or partsList.isEmpty()}" class="text-muted">Existing Part from Inventory (No parts available)</span>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="itemType" id="newPart" value="new"
                                           th:checked="${partsList == null or partsList.isEmpty()}">
                                    <label class="form-check-label" for="newPart">
                                        New Part (not in inventory)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Part Section -->
                    <div id="existingPartSection" th:style="${partsList == null or partsList.isEmpty()} ? 'display: none;' : ''">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label>Select Part <span class="text-danger">*</span></label>
                                    <select class="form-control" id="existingPartSelect">
                                        <option value="">Choose a part from inventory</option>
                                        <option th:if="${partsList != null}" th:each="part : ${partsList}" 
                                                th:value="${part.id}" 
                                                th:text="${part.code + ' - ' + part.name + ' (Stock: ' + part.stockQuantity + ')'}"
                                                th:attr="data-name=${part.name},data-code=${part.code},data-category=${part.categoryName},data-supplier=${part.supplierName},data-stock=${part.stockQuantity}"></option>
                                        <option th:if="${partsList == null or partsList.isEmpty()}" disabled>No parts available in inventory</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> Parts are loaded from inventory. If you don't see the part you need, select "New Part" option.
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Part Details Preview -->
                        <div id="partDetailsPreview" style="display: none;">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-info-circle"></i> Selected Part Details</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong>Code:</strong> <span id="previewCode"></span><br>
                                                <strong>Name:</strong> <span id="previewName"></span><br>
                                                <strong>Category:</strong> <span id="previewCategory"></span>
                                            </div>
                                            <div class="col-md-6">
                                                <strong>Supplier:</strong> <span id="previewSupplier"></span><br>
                                                <strong>Stock:</strong> <span id="previewStock"></span>
                                                <span id="stockWarning" class="text-danger" style="display: none;">
                                                    <br><i class="fas fa-exclamation-triangle"></i> Low stock alert!
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- New Part Section -->
                    <div id="newPartSection" th:style="${partsList != null and !partsList.isEmpty()} ? 'display: none;' : ''">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Part Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="newPartName" 
                                           placeholder="Enter part name">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Category</label>
                                    <input type="text" class="form-control" id="newPartCategory" 
                                           placeholder="Enter category">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Supplier</label>
                                    <input type="text" class="form-control" id="newPartSupplier" 
                                           placeholder="Enter supplier">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Description</label>
                                    <input type="text" class="form-control" id="newPartDescription" 
                                           placeholder="Enter description">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label>Specifications</label>
                                    <textarea class="form-control" id="newPartSpecifications" rows="2" 
                                              placeholder="Enter detailed specifications"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Common Fields -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Quantity <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="itemQuantity" min="1" value="1" required>
                                <small id="quantityWarning" class="text-warning" style="display: none;">
                                    <i class="fas fa-exclamation-triangle"></i> Requested quantity exceeds available stock
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Unit</label>
                                <input type="text" class="form-control" id="itemUnit" placeholder="pcs, kg, m, etc.">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Criticality</label>
                                <select class="form-control" id="itemCriticality">
                                    <option value="STANDARD">Standard</option>
                                    <option value="LOW">Low</option>
                                    <option value="MEDIUM">Medium</option>
                                    <option value="HIGH">High</option>
                                    <option value="CRITICAL">Critical</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Justification</label>
                                <textarea class="form-control" id="itemJustification" rows="2" 
                                          placeholder="Why is this part needed?"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea class="form-control" id="itemNotes" rows="2" 
                                          placeholder="Additional notes"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveItem()">
                    <i class="fas fa-plus mr-1"></i> Add Item
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- External JavaScript -->
<script th:src="@{/js/purchase-requisition-modal.js}"></script>

<!-- Add Part Modal Fragment for new many-to-many architecture -->
<div th:fragment="addPartModal" class="modal fade" id="addPartModal" tabindex="-1" role="dialog" aria-labelledby="addPartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPartModalLabel">
                    <i class="fas fa-plus-circle mr-2"></i>Add Part to Purchase Requisition
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addPartForm">
                    <!-- Part Search Section -->
                    <div class="form-group">
                        <label for="partSearch">Search Part <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="partSearch"
                               placeholder="Search Part by Name or Code" required />
                        <div id="partSearchDropdown" class="dropdown-menu w-100"
                             style="position: absolute; z-index: 1000; display: none; max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-top: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        </div>
                        <select class="d-none" name="partId" id="partSelect">
                            <option th:if="${partsList != null}" th:each="part : ${partsList}" 
                                    th:value="${part.id}" 
                                    th:text="${part.code + ' - ' + part.name + ' (Stock: ' + part.stockQuantity + ')'}"
                                    th:attr="data-name=${part.name},data-code=${part.code},data-category=${part.categoryName},data-supplier=${part.supplierName},data-stock=${part.stockQuantity}"></option>
                        </select>
                        <datalist id="partOptions">
                            <option th:if="${partsList != null}" th:each="part : ${partsList}"
                                    th:value="${part.code + ' - ' + part.name}"
                                    th:attr="data-part-id=${part.id}"></option>
                        </datalist>
                    </div>

                    <!-- Part Details Form -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="modalQuantity">Quantity <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="modalQuantity" 
                                       min="1" value="1" required>
                                <small id="stockWarning" class="text-warning" style="display: none;">
                                    <i class="fas fa-exclamation-triangle"></i> Requested quantity exceeds available stock
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="modalCriticality">Criticality Level <span class="text-danger">*</span></label>
                                <select class="form-control" id="modalCriticality" required>
                                    <option value="">Select Criticality</option>
                                    <option value="LOW">Low</option>
                                    <option value="MEDIUM" selected>Medium</option>
                                    <option value="HIGH">High</option>
                                    <option value="CRITICAL">Critical</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="modalJustification">Justification <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="modalJustification" rows="3" 
                                  placeholder="Explain why this part is needed for this requisition..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="modalNotes">Additional Notes</label>
                        <textarea class="form-control" id="modalNotes" rows="2" 
                                  placeholder="Any additional information (optional)"></textarea>
                    </div>

                    <!-- Hidden fields -->
                    <input type="hidden" id="selectedPartId">
                    <input type="hidden" id="selectedPartCode">
                    <input type="hidden" id="selectedPartName">
                    <input type="hidden" id="selectedPartCategory">
                    <input type="hidden" id="selectedPartSupplier">
                    <input type="hidden" id="selectedPartStock">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="addPartBtn" onclick="addPartToTable()" disabled>
                    <i class="fas fa-plus mr-1"></i>Add Part
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Styles Fragment -->
<th:block th:fragment="modalStyles">
    <style>
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1050;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .search-result-item {
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .search-result-item:last-child {
            border-bottom: none !important;
        }
        
        .search-result-item:hover,
        .search-result-item.active {
            background-color: #e3f2fd !important;
            border-left: 3px solid #2196f3;
        }
        
        .selected-part-display {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
        }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-dialog {
            margin: 30px auto;
        }
        
        .modal-lg {
            max-width: 800px;
        }
        
        .alert-warning {
            border-left: 4px solid #ffc107;
        }
        
        .badge-lg {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
            border-radius: 0.25rem;
        }
        
        .position-relative {
            position: relative;
        }
    </style>
</th:block>

<!-- Modal Scripts Fragment -->
<th:block th:fragment="modalScripts">
    <script>
        let partIndex = 0;
        let searchTimeout = null;
        let searchCache = new Map();
        let selectedPart = null;
        
        // Modal LiveSearch functionality
        document.addEventListener('DOMContentLoaded', function() {
            initializeModalSearch();
            
            // Reset modal when closed
            const addPartModal = document.getElementById('addPartModal');
            if (addPartModal) {
                addPartModal.addEventListener('hidden.bs.modal', function() {
                    resetModalForm();
                });
            }
            
            // Quantity change handler for stock warning
            const modalQuantity = document.getElementById('modalQuantity');
            if (modalQuantity) {
                modalQuantity.addEventListener('input', function() {
                    checkStockWarning();
                });
            }
        });
        
        function initializeModalSearch() {
            const searchInput = document.getElementById('partSearch');
            const dropdown = document.getElementById('partSearchDropdown');
            const partSelect = document.getElementById('partSelect');
            
            if (!searchInput || !dropdown || !partSelect) return;
            
            searchInput.addEventListener('input', function() {
                const term = this.value.toLowerCase().trim();
                dropdown.innerHTML = '';
                
                if (term.length < 1) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                // Filter parts based on search term
                const options = partSelect.querySelectorAll('option');
                let hasResults = false;
                
                options.forEach(option => {
                    const text = option.textContent.toLowerCase();
                    const code = option.getAttribute('data-code') || '';
                    const name = option.getAttribute('data-name') || '';
                    
                    if (text.includes(term) || code.toLowerCase().includes(term) || name.toLowerCase().includes(term)) {
                        const dropdownItem = document.createElement('div');
                        dropdownItem.className = 'dropdown-item';
                        dropdownItem.style.cursor = 'pointer';
                        dropdownItem.innerHTML = `
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>${option.getAttribute('data-code')} - ${option.getAttribute('data-name')}</strong><br>
                                    <small class="text-muted">
                                        Category: ${option.getAttribute('data-category')} | 
                                        Supplier: ${option.getAttribute('data-supplier')}
                                    </small>
                                </div>
                                <div>
                                    <span class="badge badge-${parseInt(option.getAttribute('data-stock')) > 0 ? 'success' : 'warning'}">
                                        Stock: ${option.getAttribute('data-stock')}
                                    </span>
                                </div>
                            </div>
                        `;
                        
                        dropdownItem.addEventListener('click', function() {
                            selectPart(option);
                            dropdown.style.display = 'none';
                        });
                        
                        dropdown.appendChild(dropdownItem);
                        hasResults = true;
                    }
                });
                
                if (hasResults) {
                    dropdown.style.display = 'block';
                } else {
                    dropdown.innerHTML = '<div class="dropdown-item text-muted">No parts found</div>';
                    dropdown.style.display = 'block';
                }
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        function selectPart(option) {
            selectedPart = {
                id: option.value,
                code: option.getAttribute('data-code'),
                name: option.getAttribute('data-name'),
                category: option.getAttribute('data-category'),
                supplier: option.getAttribute('data-supplier'),
                stock: parseInt(option.getAttribute('data-stock')) || 0
            };
            
            // Update search input to show selected part
            document.getElementById('partSearch').value = `${selectedPart.code} - ${selectedPart.name}`;
            
            // Enable add button
            document.getElementById('addPartBtn').disabled = false;
            
            // Check stock warning
            checkStockWarning();
        }
        
        function checkStockWarning() {
            const quantity = parseInt(document.getElementById('modalQuantity').value) || 0;
            const stockWarning = document.getElementById('stockWarning');
            
            if (selectedPart && quantity > selectedPart.stock) {
                stockWarning.style.display = 'block';
                stockWarning.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> 
                    Requested quantity (${quantity}) exceeds available stock (${selectedPart.stock})
                `;
            } else {
                stockWarning.style.display = 'none';
            }
        }
        
        function addPartToTable() {
            if (!selectedPart) {
                alert('Please select a part first');
                return;
            }
            
            const quantity = document.getElementById('modalQuantity').value;
            const criticality = document.getElementById('modalCriticality').value;
            const justification = document.getElementById('modalJustification').value;
            const notes = document.getElementById('modalNotes').value;
            
            if (!quantity || !criticality || !justification) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Check if part already exists
            const existingRows = document.querySelectorAll(`input[value="${selectedPart.id}"]`);
            if (existingRows.length > 0) {
                alert('This part is already added to the requisition');
                return;
            }
            
            // Add to table
            addPartRow(selectedPart, quantity, criticality, justification, notes);
            
            // Close modal using Bootstrap's data API (compatible with Bootstrap 4 & 5)
            const modal = document.getElementById('addPartModal');
            if (modal) {
                // Use data API which works for both Bootstrap 4 and 5
                const closeButton = modal.querySelector('[data-dismiss="modal"]');
                if (closeButton) {
                    closeButton.click();
                }
            }
        }
        
        function addPartRow(part, quantity, criticality, justification, notes) {
            const tableContainer = document.getElementById('partsTableContainer');
            const tableBody = document.getElementById('partsTableBody');
            const emptyMessage = document.getElementById('emptyPartsMessage');
            
            // Show table, hide empty message
            tableContainer.style.display = 'block';
            emptyMessage.style.display = 'none';
            
            // Create row
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <div>
                            <strong>${part.code} - ${part.name}</strong>
                            <br><small class="text-muted">
                                <i class="fas fa-tags mr-1"></i>${part.categoryName} | 
                                <i class="fas fa-truck mr-1"></i>${part.supplierName}
                            </small>
                            ${part.stock < quantity ? '<br><small class="text-warning"><i class="fas fa-exclamation-triangle"></i> Insufficient stock</small>' : ''}
                        </div>
                    </div>
                    <input type="hidden" name="parts[${partIndex}].partId" value="${part.id}">
                </td>
                <td class="text-center">
                    <span class="badge badge-primary badge-lg">${quantity}</span>
                    <input type="hidden" name="parts[${partIndex}].quantityRequested" value="${quantity}">
                </td>
                <td class="text-center">
                    <span class="badge badge-${getCriticalityColor(criticality)}">${criticality}</span>
                    <input type="hidden" name="parts[${partIndex}].criticalityLevel" value="${criticality}">
                </td>
                <td>
                    <div class="text-truncate" style="max-width: 200px;" title="${justification}">
                        ${justification}
                    </div>
                    ${notes ? `<small class="text-muted">${notes}</small>` : ''}
                    <input type="hidden" name="parts[${partIndex}].justification" value="${justification}">
                    ${notes ? `<input type="hidden" name="parts[${partIndex}].notes" value="${notes}">` : ''}
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removePartRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(row);
            partIndex++;
        }
        
        function removePartRow(button) {
            const row = button.closest('tr');
            row.remove();
            
            // If no parts remain, show empty message
            const tableBody = document.getElementById('partsTableBody');
            if (tableBody.children.length === 0) {
                document.getElementById('partsTableContainer').style.display = 'none';
                document.getElementById('emptyPartsMessage').style.display = 'block';
            }
            
            // Reindex form fields
            reindexPartRows();
        }
        
        function reindexPartRows() {
            const rows = document.querySelectorAll('#partsTableBody tr');
            rows.forEach((row, index) => {
                row.querySelectorAll('input[name*="parts["]').forEach(input => {
                    const name = input.getAttribute('name');
                    const newName = name.replace(/parts\[\d+\]/, `parts[${index}]`);
                    input.setAttribute('name', newName);
                });
            });
            partIndex = rows.length;
        }
        
        function getCriticalityColor(criticality) {
            switch(criticality) {
                case 'CRITICAL': return 'danger';
                case 'HIGH': return 'warning';
                case 'MEDIUM': return 'info';
                case 'LOW': return 'secondary';
                default: return 'secondary';
            }
        }
        
        function resetModalForm() {
            // Reset form
            document.getElementById('addPartForm').reset();
            
            // Clear selected part
            selectedPart = null;
            
            // Hide dropdown
            const dropdown = document.getElementById('partSearchDropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
            }
            
            // Reset form values
            document.getElementById('modalQuantity').value = '1';
            document.getElementById('modalCriticality').value = 'MEDIUM';
            
            // Hide stock warning
            const stockWarning = document.getElementById('stockWarning');
            if (stockWarning) {
                stockWarning.style.display = 'none';
            }
            
            // Disable add button
            const addBtn = document.getElementById('addPartBtn');
            if (addBtn) {
                addBtn.disabled = true;
            }
        }
    </script>
</th:block>